#!/bin/bash

set -eu -o pipefail

# Update the system
sudo apt -y update

# Install new packages
sudo apt install -y python3-pip git micro build-essential

# Remove kernel packages
sudo apt -y --purge remove linux-image-generic-hwe-20.04 "^linux-.*5\..*"

# Absolutely remove all kernels
sudo rm -f /boot/*5*

# Add base kernel after removing HWE kernel
sudo apt -y install linux-generic

# Remove extra packages
sudo apt -y --purge remove "^alsa.*" alsa-utils pulseaudio snapd whoopsie apport apparmor update-manager update-notifier unattended-upgrades bluez enchant-2 wamerican wbritish speech-dispatcher brltty gnome-accessibility-themes gnome-bluetooth gnome-calculator gnome-characters gnome-disk-utility gnome-font-viewer gnome-getting-started-docs gnome-initial-setup gnome-logs gnome-online-accounts gnome-themes-extra gnome-themes-extra-data ubuntu-advantage-tools ubuntu-docs ubuntu-report yaru-theme-sound yaru-theme-icon yelp apt-utils "^fonts-noto.*" usbmuxd usbutils usb-modeswitch system-config-printer-udev switcheroo-control squashfs-tools rfkill "^printer-driver.*" ppp pcmciautils openvpn ntfs-3g modemmanager mobile-broadband-provider-info memtest86+ linux-sound-base gstreamer1.0-tools gstreamer1.0-pulseaudio gstreamer1.0-gl gstreamer1.0-alsa gpg ghostscript gdb gamemode fuse fprintd foomatic-db-compressed-ppds evince eog "^cups.*" fonts-kacst fonts-kacst-one fonts-khmeros-core fonts-lklug-sinhala fonts-lohit-guru fonts-guru fonts-nanum fonts-nakula fonts-navilu fonts-opensymbol fonts-orya fonts-pagul "^fonts-samyak.*" fonts-sarai "^fonts-smc.*" fonts-taml fonts-telu fonts-noto-cjk fonts-takao-pgothic fonts-tibetan-machine fonts-guru-extra fonts-lao fonts-sil-padauk fonts-sil-abyssinica "^fonts-tlwg-.*" "^fonts-lohit-.*" "^ibus.*" rygel humanity-icon-theme locales xserver-xorg-input-wacom xserver-xorg-video-all xserver-xorg-legacy xul-ext-ubufox xserver-xephyr whiptail xdg-utils xdg-user-dirs xcursor-themes ufw iptables strace ltrace logrotate rsyslog rsync popularity-contest lshw openprinting-ppds update-manager-core psmisc poppler-utils poppler-data plymouth update-inetd publicsuffix powermgmt-base pciutils os-prober network-manager-config-connectivity-ubuntu packagekit network-manager-gnome nautilus-sendto mousetweaks mtr-tiny kerneloops info hdparm gpg-agent gedit ed eject "^busybox.*" bc "^avahi.*" aspell appstream acpid acl

# Remove dependencies
sudo apt -y --purge autoremove

# Upgrade the system
sudo apt -y upgrade

# Remove temp files
sudo apt clean
shopt -s dotglob
rm -rf /home/user/*
sudo rm -rf /root/*
sudo rm -rf /tmp/*
sudo rm -rf /var/log/*
sudo rm -rf /var/backups/*
sudo rm -rf /var/cache/*
sudo rm -rf /var/lib/apt/lists

# Remove old boot images
sudo rm -f /boot/*.old

# Zero free space    
dd bs=4M if=/dev/zero of=/var/tmp/empty || rm /var/tmp/empty

# Adjust Gnome settings
# Disable screen blanking
gsettings set org.gnome.desktop.session idle-delay 0
# Disable screen locking after suspend
gsettings set org.gnome.desktop.lockdown disable-lock-screen true
# Disable screen locking from screensaver
gsettings set org.gnome.desktop.screensaver lock-enabled false

# Shut down
sudo shutdown now
